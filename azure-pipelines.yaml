variables:
  packageVersion: $(Build.BuildNumber)

resources:
- repo: self
  clean: true

jobs:

# ------- Windows x64 ---------------------------------------------------------
- job: windows_x64
  condition: succeeded()
  pool:
    name: Hosted VS2017
    demands:
    - msbuild
    - visualstudio

  steps:
  - checkout: self
    clean: true
    submodules: true

  - task: PowerShell@2
    displayName: 'Set build number'
    inputs:
      targetType: inline
      workingDirectory: include/mbedtls
      script: |
       $v = @{}
       $path = Join-Path (Get-Location) 'version.h'
       foreach($line in Get-Content -Path $path)
       {
           $m = [regex]::Match($line, '#define[\t\s]+([1-9a-zA-Z_]+)[\t\s]+(.*)')
           if($m.Success)
           {
               $v.Add($m.Groups[1].Value, $m.Groups[2].Value.Trim())
           }
       }
       $version = "$($v['MBEDTLS_VERSION_MAJOR']).$($v['MBEDTLS_VERSION_MINOR']).$($v['MBEDTLS_VERSION_PATCH']).$($Env:BUILD_BUILDID)"
       Write-Host "##vso[build.updatebuildnumber]$version"
       Write-Host "##vso[task.setvariable variable=packageVersion]$version"

  - task: CMake@1
    displayName: 'Cmake x64'
    inputs:
      cmakeArgs: '. -G "Visual Studio 15 2017" -A x64 -DENABLE_TESTING=OFF -DUSE_SHARED_MBEDTLS_LIBRARY=ON'
      workingDirectory: .
      
  - task: VSBuild@1
    displayName: 'Build solution x64'
    inputs:
      solution: 'mbed TLS.sln'
      vsVersion: 15.0
      platform: x64
      configuration: release
      clean: true
      #msbuildArgs: /m

  - task: CmdLine@2
    displayName: 'Run tests x64'
    inputs:
      script: 'programs\test\Release\selftest.exe'

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'crypto\library\Release'
      artifactName: win-x64

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'library\Release'
      artifactName: win-x64

# ------- Linux -------------------------------------------------------------
- job: linux_x64
  condition: succeeded()
  pool:
    name: Hosted Ubuntu 1604
  steps:
  - checkout: self
    clean: true
    submodules: true
    
  - task: CMake@1
    displayName: 'Generate project'
    inputs:
      cmakeArgs: '. -DENABLE_TESTING=ON -DUSE_SHARED_MBEDTLS_LIBRARY=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_LIBRARY_OUTPUT_DIRECTORY=$(Build.ArtifactStagingDirectory)'
      workingDirectory: .

  - task: Bash@3
    displayName: 'Build'
    inputs:
      targetType: inline
      script: make

  - task: Bash@3
    displayName: 'Test'
    inputs:
      targetType: inline
      script: make test
      
  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: linux-x64

# ------- Darwin -------------------------------------------------------------
- job: osx
  condition: succeeded()
  pool:
    name: Hosted macOS High Sierra
  steps:
  - checkout: self
    clean: true
    submodules: true

  - task: CMake@1
    displayName: 'Generate project'
    inputs:
      cmakeArgs: '. -G Xcode -DENABLE_TESTING=ON -DUSE_SHARED_MBEDTLS_LIBRARY=ON -DCMAKE_BUILD_TYPE=Release'
      workingDirectory: .

  - task: CMake@1
    displayName: 'Compile'
    inputs:
      cmakeArgs: '--build . --config Release'
      workingDirectory: .

  - task: Bash@3
    displayName: 'Test'
    inputs:
      targetType: inline
      script: make test
      
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'crypto/library/Release'
      artifactName: osx

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: 'library/Release'
      artifactName: osx

# ------- Package ---------------------------------------------------------
- job: package
  dependsOn:
  - windows_x64
  - linux_x64
  - osx
  condition: succeeded()
  pool:
    name: Hosted
  steps:
  - checkout: self
    clean: true
    submodules: true

  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build Artifacts'
    inputs:
      downloadType: specific
      downloadPath: runtimes

  - powershell: |
     Get-ChildItem -Path runtimes -File -Recurse -Filter '*.so.*' | Remove-Item -Force
     Get-ChildItem -Path runtimes -File -Recurse -Filter '*.a' | Remove-Item -Force
     Get-ChildItem -Path runtimes -File -Recurse -Filter '*.1*.dylib' | Remove-Item -Force
     Get-ChildItem -Path runtimes -File -Recurse -Filter '*.2*.dylib' | Remove-Item -Force
     Get-ChildItem -Path runtimes -File -Recurse -Filter '*.3*.dylib' | Remove-Item -Force
     Get-ChildItem -Path runtimes -File -Recurse -Filter '*.exp' | Remove-Item -Force
     Get-ChildItem -Path runtimes -File -Recurse -Filter '*.lib' | Remove-Item -Force
    
  - task: NuGetToolInstaller@0
    inputs:
      versionSpec: '5.0.2' 
    
  - task: NuGetCommand@2
    displayName: 'NuGet pack'
    inputs:
      command: pack
      packagesToPack: mbedtls.nuspec
      versioningScheme: byEnvVar
      versionEnvVar: packageVersion
      
  - task: NuGetCommand@2
    displayName: 'NuGet push private feed'
    inputs:
      command: push
      publishVstsFeed: '/be2f0cee-544d-407b-b4bf-6dcb58c6e898'

  - task: NuGetCommand@2
    displayName: 'NuGet push nuget.org feed'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    inputs:
      command: push
      nuGetFeedType: external
      publishFeedCredentials: nuget.org